import re
import io
import fitz  # PyMuPDF for PDF text extraction
from collections import Counter
from typing import Dict, List

# =============== INPUTS ===============

def read_resume_pdf(file_path: str) -> str:
    """Extract text from a PDF resume."""
    with fitz.open(file_path) as pdf:
        text = ""
        for page in pdf:
            text += page.get_text("text")
    return text.strip()

def preprocess_text(text: str) -> str:
    """Basic cleaning for text comparison."""
    text = text.lower()
    text = re.sub(r'[^a-z0-9\s]', '', text)
    return text

# =============== ANALYZER CORE ===============

def calculate_ats_score(resume_text: str, job_description: str) -> Dict:
    """Analyze resume text vs job description."""
    
    resume_text_clean = preprocess_text(resume_text)
    jd_clean = preprocess_text(job_description)

    # Tokenize
    resume_words = set(resume_text_clean.split())
    jd_words = set(jd_clean.split())

    # ===== 1ï¸âƒ£ Keyword Match (30 pts) =====
    matched_keywords = resume_words.intersection(jd_words)
    keyword_score = min(30, (len(matched_keywords) / len(jd_words)) * 30)

    # ===== 2ï¸âƒ£ Skills Alignment (25 pts) =====
    skill_keywords = [
        "salesforce", "customer service", "data entry", "excel", "crm",
        "document management", "communication", "filing", "project support",
        "reporting", "microsoft office", "teamwork", "problem solving"
    ]
    matched_skills = [s for s in skill_keywords if s in resume_text_clean]
    skills_score = (len(matched_skills) / len(skill_keywords)) * 25

    # ===== 3ï¸âƒ£ Experience Relevance (20 pts) =====
    experience_keywords = [
        "experience", "managed", "handled", "coordinated", "supported",
        "projects", "clients", "reporting", "operations"
    ]
    matched_exp = [e for e in experience_keywords if e in resume_text_clean]
    exp_score = (len(matched_exp) / len(experience_keywords)) * 20

    # ===== 4ï¸âƒ£ ATS Formatting (15 pts) =====
    ats_format_penalty = 0
    if 'table' in resume_text.lower() or 'graphic' in resume_text.lower():
        ats_format_penalty = 3  # simple penalty if tables/graphics detected
    ats_score = 15 - ats_format_penalty

    # ===== 5ï¸âƒ£ Qualification Match (10 pts) =====
    qualification_keywords = ["bachelor", "degree", "diploma", "certification"]
    matched_qual = [q for q in qualification_keywords if q in resume_text_clean]
    qual_score = (len(matched_qual) / len(qualification_keywords)) * 10

    # ===== Final =====
    total_score = round(keyword_score + skills_score + exp_score + ats_score + qual_score, 2)
    missing_keywords = list(jd_words - resume_words)
    missing_skills = [s for s in skill_keywords if s not in resume_text_clean]

    return {
        "Total ATS Score": total_score,
        "Breakdown": {
            "Keyword Match": round(keyword_score, 2),
            "Skills Alignment": round(skills_score, 2),
            "Experience Relevance": round(exp_score, 2),
            "ATS Formatting": round(ats_score, 2),
            "Qualifications Match": round(qual_score, 2)
        },
        "Matched Keywords": list(matched_keywords),
        "Missing Keywords": missing_keywords[:15],  # top 15 missing
        "Missing Skills": missing_skills,
    }

# =============== IMPROVEMENT SUGGESTIONS ===============

def generate_recommendations(result: Dict) -> List[str]:
    """Generate optimization recommendations based on missing elements."""
    recommendations = []

    if result["Breakdown"]["Keyword Match"] < 25:
        recommendations.append("Add more keywords from the job description (especially ones related to Salesforce, document management, and customer communication).")

    if result["Breakdown"]["Skills Alignment"] < 20:
        recommendations.append(f"Include missing skills: {', '.join(result['Missing Skills'][:5])}")

    if result["Breakdown"]["Experience Relevance"] < 15:
        recommendations.append("Add more project or client-handling experience descriptions using action verbs like 'managed', 'supported', 'coordinated'.")

    if result["Breakdown"]["Qualifications Match"] < 8:
        recommendations.append("Add your educational qualifications clearly, e.g., 'Bachelorâ€™s Degree in Business Administration'.")

    recommendations.append("Keep formatting simple â€” use plain text, consistent bullet points, and avoid tables or images for ATS compatibility.")

    return recommendations

# =============== MAIN FLOW ===============

def run_ats_resume_analyzer(resume_path: str, job_description: str):
    resume_text = read_resume_pdf(resume_path)
    result = calculate_ats_score(resume_text, job_description)
    suggestions = generate_recommendations(result)

    print("\n===== ATS RESUME ANALYZER REPORT =====")
    print(f"Total Score: {result['Total ATS Score']}/100\n")
    print("Breakdown:")
    for k, v in result["Breakdown"].items():
        print(f"  - {k}: {v}")

    print("\nMissing Keywords:", ', '.join(result["Missing Keywords"][:10]))
    print("Missing Skills:", ', '.join(result["Missing Skills"]))
    print("\nðŸ“ˆ Recommendations:")
    for i, rec in enumerate(suggestions, 1):
        print(f"{i}. {rec}")

# =============== EXAMPLE USAGE ===============

if __name__ == "__main__":
    job_description = """
    Responding to internal client inquiries via email or Salesforce chatter.
    Assisting in various EMC/EPS Projects such as Group Split projects, minute book and document uploads,
    and managing customer portfolios. Providing exceptional customer service, maintaining and updating records,
    and handling corporate filings.
    """

    # Example: update with your own resume file path
    resume_file_path = "resume.pdf"
    run_ats_resume_analyzer(resume_file_path, job_description)
